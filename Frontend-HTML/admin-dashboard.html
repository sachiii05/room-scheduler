<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#e73c4e" />
  <meta name="description" content="BSU Room Scheduling - Admin Dashboard" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <title>BSU Room Scheduling - Admin Dashboard</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    /* Notification styles */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      max-width: 350px;
      animation: slideIn 0.3s ease-out forwards;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
    
    .notification.success {
      background-color: #4CAF50;
    }
    
    .notification.error {
      background-color: #f44336;
    }
    
    .notification.info {
      background-color: #2196F3;
    }
    
    .notification i {
      margin-right: 10px;
      font-size: 18px;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f8f9fa;
      color: #333;
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar Styles */
    .sidebar {
      width: 88px;
      background-color: #e73c4e;
      color: white;
      position: fixed;
      height: 100vh;
      left: 0;
      top: 0;
      z-index: 100;
      transition: width 0.3s ease;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
    }

    .sidebar:hover {
      width: 240px;
    }

    .sidebar-header {
      padding: 20px 15px;
      display: flex;
      align-items: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .sidebar-header h1 {
      font-size: 1.2rem;
      margin-left: 15px;
      white-space: nowrap;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .sidebar:hover .sidebar-header h1 {
      opacity: 1;
    }

    .sidebar-menu {
      list-style: none;
      padding: 0;
      margin-top: 20px;
      flex-grow: 1;
    }

    .sidebar-menu li {
      margin-bottom: 5px;
    }

    .sidebar-menu a {
      display: flex;
      align-items: center;
      padding: 15px;
      color: white;
      text-decoration: none;
      transition: background-color 0.3s;
      white-space: nowrap;
    }

    .sidebar-menu a:hover, .sidebar-menu a.active {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .sidebar-menu i {
      font-size: 20px;
      min-width: 40px;
      text-align: center;
    }

    .sidebar-menu span {
      margin-left: 10px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .sidebar:hover .sidebar-menu span {
      opacity: 1;
    }

    .logout-link {
      margin-top: auto;
      margin-bottom: 20px;
    }

    /* Main Content Styles */
    .main-content {
      flex: 1;
      margin-left: 88px;
      padding: 20px;
      transition: margin-left 0.3s ease;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .search-bar {
      display: flex;
      align-items: center;
      background-color: white;
      border-radius: 50px;
      padding: 8px 15px;
      width: 300px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .search-bar input {
      border: none;
      outline: none;
      width: 100%;
      padding: 5px 10px;
      font-size: 14px;
    }

    .search-bar i {
      color: #999;
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .notification-icon {
      position: relative;
    }

    .notification-icon i {
      font-size: 20px;
      color: #666;
    }

    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background-color: #e73c4e;
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      overflow: hidden;
    }

    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Dashboard Content */
    .dashboard-title {
      font-size: 24px;
      font-weight: 500;
      margin-bottom: 20px;
      color: #333;
    }

    .stats-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background-color: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .stat-info h3 {
      font-size: 14px;
      font-weight: 500;
      color: #666;
      margin-bottom: 5px;
    }

    .stat-info p {
      font-size: 28px;
      font-weight: 600;
      color: #333;
    }

    .stat-icon {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .rooms-icon {
      background-color: rgba(231, 60, 78, 0.1);
      color: #e73c4e;
    }

    .bookings-icon {
      background-color: rgba(25, 118, 210, 0.1);
      color: #1976d2;
    }

    .revenue-icon {
      background-color: rgba(76, 175, 80, 0.1);
      color: #4CAF50;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
    }

    .chart-container {
      background-color: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .chart-title {
      font-size: 18px;
      font-weight: 500;
    }

    .chart-filters {
      display: flex;
      gap: 10px;
    }

    .chart-filter {
      font-size: 13px;
      padding: 5px 10px;
      border-radius: 20px;
      cursor: pointer;
      background-color: #f5f5f5;
    }

    .chart-filter.active {
      background-color: #e73c4e;
      color: white;
    }

    .activities-container {
      background-color: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .activities-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .activities-title {
      font-size: 18px;
      font-weight: 500;
    }

    .activity-item {
      display: flex;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .activity-item:last-child {
      border-bottom: none;
    }

    .activity-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      overflow: hidden;
      margin-right: 15px;
    }

    .activity-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .activity-details {
      flex: 1;
    }

    .activity-user {
      font-weight: 500;
      margin-bottom: 3px;
    }

    .activity-action {
      font-size: 13px;
      color: #666;
    }

    .activity-time {
      font-size: 12px;
      color: #999;
    }

    /* Hidden sections */
    .hidden-section {
      display: none;
    }

    /* Buttons */
    .btn {
      display: inline-block;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .btn-primary {
      background-color: #e73c4e;
      color: white;
    }

    .btn-primary:hover {
      background-color: #d1313f;
    }

    .btn-success {
      background-color: #4CAF50;
      color: white;
    }

    .btn-danger {
      background-color: #f44336;
      color: white;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 30px;
      border-radius: 10px;
      max-width: 500px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .form-group input, .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    /* Responsive */
    @media (max-width: 992px) {
      .stats-container {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .stats-container {
        grid-template-columns: 1fr;
      }
      
      .search-bar {
        width: 200px;
      }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <i class="fas fa-th-large"></i>
      <h1>Dashboard</h1>
    </div>
    <ul class="sidebar-menu">
      <li>
        <a href="#dashboard" id="dashboard-link" class="active">
          <i class="fas fa-home"></i>
          <span>Dashboard</span>
        </a>
      </li>
      <li>
        <a href="#pending-bookings" id="pending-bookings-link">
          <i class="fas fa-calendar-check"></i>
          <span>Pending Bookings</span>
        </a>
      </li>
      <li>
        <a href="#room-management" id="room-management-link">
          <i class="fas fa-door-open"></i>
          <span>Room Management</span>
        </a>
      </li>
      <li>
        <a href="create-room.html">
          <i class="fas fa-plus-circle"></i>
          <span>Create Room</span>
        </a>
      </li>
      <li>
        <a href="#" id="profile-link">
          <i class="fas fa-user"></i>
          <span>Profile</span>
        </a>
      </li>
      <li class="logout-link">
        <a href="#" id="logout-link">
          <i class="fas fa-sign-out-alt"></i>
          <span>Logout</span>
        </a>
      </li>
    </ul>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <div class="header">
      <div class="search-bar">
        <i class="fas fa-search"></i>
        <input type="text" placeholder="Search...">
      </div>
      <div class="user-profile">
        <div class="notification-icon">
          <i class="fas fa-bell"></i>
          <span class="notification-badge">3</span>
        </div>
        <div class="user-avatar">
          <img src="https://randomuser.me/api/portraits/men/1.jpg" alt="Admin" id="user-avatar">
        </div>
        <span id="admin-name">Admin</span>
      </div>
    </div>

    <!-- Dashboard Content -->
    <div id="dashboard-section">
      <h1 class="dashboard-title">Analytic Overview</h1>
      
      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-info">
            <h3>TOTAL ROOMS</h3>
            <p id="total-rooms-count">0</p>
          </div>
          <div class="stat-icon rooms-icon">
            <i class="fas fa-door-open"></i>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-info">
            <h3>TOTAL BOOKINGS</h3>
            <p id="total-bookings-count">0</p>
          </div>
          <div class="stat-icon users-icon">
            <i class="fas fa-calendar"></i>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-info">
            <h3>PENDING BOOKINGS</h3>
            <p id="pending-bookings-count">0</p>
          </div>
          <div class="stat-icon revenue-icon">
            <i class="fas fa-clock"></i>
          </div>
        </div>
      </div>
      
      <div class="dashboard-grid">
        <div class="chart-container">
          <div class="chart-header">
            <h2 class="chart-title">Booking Statistics</h2>
            <div class="chart-filters">
              <div class="chart-filter" id="monthly-filter">Monthly</div>
              <div class="chart-filter active" id="quarterly-filter">Quarterly</div>
              <div class="chart-filter" id="yearly-filter">Yearly</div>
            </div>
          </div>
          <canvas id="booking-chart" height="250"></canvas>
        </div>
        
        <div class="activities-container">
          <div class="activities-header">
            <h2 class="activities-title">Recent Activities</h2>
          </div>
          <div id="activities-list">
            <!-- Activities will be loaded here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Hidden sections that will be shown when clicked on sidebar -->
    <div class="hidden-section" id="pending-bookings-section">
      <h1 class="dashboard-title">Pending Bookings</h1>
      <div id="booking-requests">
        <p id="no-bookings-message" style="display: none;">No pending bookings</p>
        <!-- Booking requests will be loaded here -->
      </div>
    </div>

    <div class="hidden-section" id="room-management-section">
      <h1 class="dashboard-title">Room Management</h1>
      <div class="admin-actions" style="margin-bottom: 20px;">
        <button class="btn btn-primary" onclick="openRoomForm()">
          <i class="fas fa-plus"></i> Add New Room
        </button>
      </div>
      <div id="room-list">
        <p id="no-rooms-message" style="display: none;">No rooms available</p>
        <!-- Rooms will be loaded here -->
      </div>
    </div>
  </main>

  <!-- Room Form Modal -->
  <div id="room-form-modal" class="modal">
    <div class="modal-content">
      <h2 id="modal-title">Create Room</h2>
      <form id="room-form">
        <div class="form-group">
          <label for="room-name">Room Name</label>
          <input type="text" id="room-name" name="name" required />
        </div>
        <div class="form-group">
          <label for="room-location">Location</label>
          <input type="text" id="room-location" name="location" required />
        </div>
        <div class="form-group">
          <label for="room-capacity">Capacity</label>
          <input type="number" id="room-capacity" name="capacity" min="1" required />
        </div>
        <button type="submit" class="btn">Save</button>
        <button type="button" class="btn btn-secondary" onclick="closeRoomForm()">Cancel</button>
      </form>
    </div>
  </div>

  <script type="module">
    import auth from './js/auth.js';
    import config from './js/config.js';

    // Handle sidebar navigation
    function hideAllSections() {
      document.querySelectorAll('[id$="-section"]').forEach(section => {
        section.style.display = 'none';
      });
      
      // Remove active class from all links
      document.querySelectorAll('.sidebar-menu a').forEach(link => {
        link.classList.remove('active');
      });
    }
    
    // Show dashboard stats only
    function showDashboard() {
      hideAllSections();
      document.getElementById('dashboard-section').style.display = 'block';
      document.getElementById('dashboard-link').classList.add('active');
    }
    
    // Show pending bookings section
    function showPendingBookings() {
      hideAllSections();
      document.getElementById('pending-bookings-section').style.display = 'block';
      document.getElementById('pending-bookings-link').classList.add('active');
    }
    
    // Show room management section
    function showRoomManagement() {
      hideAllSections();
      document.getElementById('room-management-section').style.display = 'block';
      document.getElementById('room-management-link').classList.add('active');
    }
    
    // Set up sidebar navigation event listeners
    document.getElementById('dashboard-link').addEventListener('click', (e) => {
      e.preventDefault();
      showDashboard();
      history.pushState(null, '', '#dashboard');
    });
    
    document.getElementById('pending-bookings-link').addEventListener('click', (e) => {
      e.preventDefault();
      showPendingBookings();
      history.pushState(null, '', '#pending-bookings');
    });
    
    document.getElementById('room-management-link').addEventListener('click', (e) => {
      e.preventDefault();
      showRoomManagement();
      history.pushState(null, '', '#room-management');
    });
    
    // Check hash on page load
    function checkHash() {
      const hash = window.location.hash;
      if (hash === '#pending-bookings') {
        showPendingBookings();
      } else if (hash === '#room-management') {
        showRoomManagement();
      } else {
        showDashboard();
      }
    }
    
    // Initialize chart
    async function initChart() {
      try {
        const ctx = document.getElementById('booking-chart');
        if (!ctx) {
          console.warn('Booking chart canvas not found');
          return;
        }
        
        if (typeof Chart === 'undefined') {
          console.error('Chart.js is not loaded');
          return;
        }
        
        const token = localStorage.getItem('token');
        
        // Fetch all bookings to create the chart
        const response = await fetch(`${config.apiBaseUrl}${config.apiEndpoints.bookings}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          throw new Error('Failed to fetch bookings for chart');
        }
        
        const bookings = await response.json();
        
        // Process bookings to get data by day
        const bookingsByDay = processBookingsByDay(bookings);
        const last7Days = getLast7Days();
        
        const bookingChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: last7Days.map(day => day.label),
            datasets: [{
              label: 'Bookings',
              data: last7Days.map(day => bookingsByDay[day.date] || 0),
              borderColor: '#e73c4e',
              backgroundColor: 'rgba(231, 60, 78, 0.1)',
              borderWidth: 2,
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: 'top',
              },
              title: {
                display: false
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  color: 'rgba(0, 0, 0, 0.05)'
                }
              },
              x: {
                grid: {
                  display: false
                }
              }
            }
          }
        });
        
        // Store chart reference for later updates
        window.bookingChart = bookingChart;
        
        // Filter buttons
        document.querySelectorAll('.chart-filter').forEach(button => {
          button.addEventListener('click', async function() {
            document.querySelectorAll('.chart-filter').forEach(btn => {
              btn.classList.remove('active');
            });
            this.classList.add('active');
            
            // Update chart data based on filter
            let dateRange;
            let groupBy;
            
            if (this.id === 'monthly-filter') {
              dateRange = getLast30Days();
              groupBy = 'day';
            } else if (this.id === 'quarterly-filter') {
              dateRange = getLast90Days();
              groupBy = 'week';
            } else if (this.id === 'yearly-filter') {
              dateRange = getLast12Months();
              groupBy = 'month';
            }
            
            updateChartWithDateRange(bookings, dateRange, groupBy);
          });
        });
      } catch (error) {
        console.error('Error initializing chart:', error);
      }
    }
    
    // Helper function to process bookings by day
    function processBookingsByDay(bookings) {
      const bookingsByDay = {};
      
      bookings.forEach(booking => {
        const date = new Date(booking.startTime);
        const dateString = date.toISOString().split('T')[0]; // YYYY-MM-DD format
        
        if (!bookingsByDay[dateString]) {
          bookingsByDay[dateString] = 0;
        }
        
        bookingsByDay[dateString]++;
      });
      
      return bookingsByDay;
    }
    
    // Helper function to get last 7 days
    function getLast7Days() {
      const result = [];
      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateString = date.toISOString().split('T')[0];
        const label = date.toLocaleDateString('en-US', { weekday: 'short' });
        result.push({ date: dateString, label });
      }
      return result;
    }
    
    // Helper function to get last 30 days
    function getLast30Days() {
      const result = [];
      for (let i = 29; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateString = date.toISOString().split('T')[0];
        const label = `${date.getMonth() + 1}/${date.getDate()}`;
        result.push({ date: dateString, label });
      }
      return result;
    }
    
    // Helper function to get last 90 days by week
    function getLast90Days() {
      const result = [];
      for (let i = 12; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - (i * 7));
        const dateString = date.toISOString().split('T')[0];
        const label = `Week ${12-i+1}`;
        result.push({ date: dateString, label });
      }
      return result;
    }
    
    // Helper function to get last 12 months
    function getLast12Months() {
      const result = [];
      for (let i = 11; i >= 0; i--) {
        const date = new Date();
        date.setMonth(date.getMonth() - i);
        date.setDate(1);
        const dateString = date.toISOString().split('T')[0];
        const label = date.toLocaleDateString('en-US', { month: 'short' });
        result.push({ date: dateString, label });
      }
      return result;
    }
    
    // Update chart with date range
    function updateChartWithDateRange(bookings, dateRange, groupBy) {
      if (!window.bookingChart) return;
      
      let bookingsByPeriod = {};
      
      if (groupBy === 'day') {
        bookingsByPeriod = processBookingsByDay(bookings);
      } else if (groupBy === 'week') {
        // Group by week (simplified)
        bookingsByPeriod = processBookingsByDay(bookings);
      } else if (groupBy === 'month') {
        // Group by month
        bookings.forEach(booking => {
          const date = new Date(booking.startTime);
          const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
          
          if (!bookingsByPeriod[monthYear]) {
            bookingsByPeriod[monthYear] = 0;
          }
          
          bookingsByPeriod[monthYear]++;
        });
      }
      
      window.bookingChart.data.labels = dateRange.map(period => period.label);
      window.bookingChart.data.datasets[0].data = dateRange.map(period => {
        if (groupBy === 'day') {
          return bookingsByPeriod[period.date] || 0;
        } else if (groupBy === 'week') {
          // For week, sum the 7 days
          let sum = 0;
          for (let i = 0; i < 7; i++) {
            const date = new Date(period.date);
            date.setDate(date.getDate() + i);
            const dateString = date.toISOString().split('T')[0];
            sum += bookingsByPeriod[dateString] || 0;
          }
          return sum;
        } else if (groupBy === 'month') {
          // For month, get the month-year
          const date = new Date(period.date);
          const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
          return bookingsByPeriod[monthYear] || 0;
        }
        return 0;
      });
      
      window.bookingChart.update();
    }
    
    // Load recent activities
    async function loadRecentActivities() {
      try {
        const activitiesList = document.getElementById('activities-list');
        
        // Fetch recent activities from API
        const token = localStorage.getItem('token');
        // Use regular bookings endpoint instead of /recent since it doesn't exist
        const response = await fetch(`${config.apiBaseUrl}${config.apiEndpoints.bookings}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          throw new Error('Failed to fetch recent activities');
        }
        
        const bookings = await response.json();
        
        // Sort by creation date (newest first) and take only 5
        const recentBookings = bookings
          .sort((a, b) => new Date(b.createdAt || b.startTime) - new Date(a.createdAt || a.startTime))
          .slice(0, 5);
        
        activitiesList.innerHTML = '';
        
        if (recentBookings.length === 0) {
          activitiesList.innerHTML = '<div class="no-activities">No recent booking activities</div>';
          return;
        }
        
        recentBookings.forEach(booking => {
          const activityEl = document.createElement('div');
          activityEl.className = 'activity-item';
          // Format date for display
          const bookingTime = new Date(booking.createdAt || booking.startTime);
          const timeAgo = getTimeAgo(bookingTime);
          
          // Get user and room info safely
          const userName = booking.user?.name || 'User';
          const roomName = booking.room?.name || 'Room';
          const status = booking.status || 'pending';
          
          activityEl.innerHTML = `
            <div class="activity-avatar">
              <img src="https://randomuser.me/api/portraits/lego/1.jpg" alt="${userName}">
            </div>
            <div class="activity-details">
              <div class="activity-user">${userName}</div>
              <div class="activity-action">${status === 'pending' ? 'requested' : status} ${roomName}</div>
              <div class="activity-time">${timeAgo}</div>
            </div>
          `;
          activitiesList.appendChild(activityEl);
        });
      } catch (error) {
        console.error('Error loading activities:', error);
      }
    }
    
    // Check hash on load and when it changes
    window.addEventListener('hashchange', checkHash);
    
    // Load user info
    document.addEventListener('DOMContentLoaded', async function() {
      if (!auth.isAuthenticated()) {
        window.location.href = 'index.html';
        return;
      }

      const user = auth.getUser();
      if (user.role !== 'admin') {
        window.location.href = 'dashboard.html';
        return;
      }

      document.getElementById('admin-name').textContent = user.name || 'Admin';
      
      // Initialize chart
      initChart();
      
      // Load recent activities
      loadRecentActivities();
      
      // Load booking requests
      await loadBookingRequests();
      
      // Load rooms
      await loadRooms();
      
      // Update dashboard statistics
      updateDashboardStats();
      
      // Check hash to show appropriate section
      checkHash();
    });
    
    // Function to update dashboard statistics
    async function updateDashboardStats() {
      try {
        const token = localStorage.getItem('token');
        
        // Get all rooms to count them
        const roomsResponse = await fetch(`${config.apiBaseUrl}${config.apiEndpoints.rooms}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (roomsResponse.ok) {
          const rooms = await roomsResponse.json();
          console.log('Rooms data from API:', rooms);
          document.getElementById('total-rooms-count').textContent = rooms.length || '0';
        } else {
          console.error('Failed to fetch rooms:', roomsResponse.status);
          document.getElementById('total-rooms-count').textContent = '0';
        }
        
        // Get all bookings to count them
        const bookingsResponse = await fetch(`${config.apiBaseUrl}${config.apiEndpoints.bookings}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (bookingsResponse.ok) {
          const bookings = await bookingsResponse.json();
          console.log('Bookings data from API:', bookings);
          document.getElementById('total-bookings-count').textContent = bookings.length || '0';
          
          // Count pending bookings
          const pendingBookings = bookings.filter(booking => booking.status === 'pending');
          document.getElementById('pending-bookings-count').textContent = pendingBookings.length || '0';
          
          // Also update the chart with this data
          if (window.bookingChart) {
            const bookingsByDay = processBookingsByDay(bookings);
            const last7Days = getLast7Days();
            
            window.bookingChart.data.datasets[0].data = last7Days.map(day => bookingsByDay[day.date] || 0);
            window.bookingChart.update();
          }
        } else {
          console.error('Failed to fetch bookings:', bookingsResponse.status);
          document.getElementById('total-bookings-count').textContent = '0';
          document.getElementById('pending-bookings-count').textContent = '0';
        }
      } catch (error) {
        console.error('Error updating dashboard stats:', error);
        document.getElementById('total-rooms-count').textContent = '0';
        document.getElementById('total-bookings-count').textContent = '0';
        document.getElementById('pending-bookings-count').textContent = '0';
      }
    }

    // Show notification
    function showNotification(message, type = 'info') {
      // Remove any existing notifications
      const existingNotifications = document.querySelectorAll('.notification');
      existingNotifications.forEach(notification => {
        notification.style.animation = 'slideOut 0.3s ease-out forwards';
        setTimeout(() => notification.remove(), 300);
      });
      
      // Create notification element
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      
      // Add icon based on type
      let icon = '';
      if (type === 'success') icon = 'check-circle';
      else if (type === 'error') icon = 'exclamation-circle';
      else if (type === 'info') icon = 'info-circle';
      
      notification.innerHTML = `<i class="fas fa-${icon}"></i>${message}`;
      document.body.appendChild(notification);
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-out forwards';
        setTimeout(() => notification.remove(), 300);
      }, 5000);
    }
    
    // Add event listeners for booking actions
    function addBookingActionListeners() {
      // First remove any existing event listeners to prevent duplicates
      document.querySelectorAll('.approve-btn').forEach(button => {
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);
      });
      
      document.querySelectorAll('.reject-btn').forEach(button => {
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);
      });
      
      // Add new event listeners
      document.querySelectorAll('.approve-btn').forEach(button => {
        button.addEventListener('click', function() {
          const bookingId = this.getAttribute('data-booking-id');
          if (bookingId) {
            approveBooking(bookingId);
          } else {
            showNotification('Booking ID not found', 'error');
          }
        });
      });
      
      // Reject buttons
      document.querySelectorAll('.reject-btn').forEach(button => {
        button.addEventListener('click', function() {
          const bookingId = this.getAttribute('data-booking-id');
          if (bookingId) {
            rejectBooking(bookingId);
          } else {
            showNotification('Booking ID not found', 'error');
          }
        });
      });
    }
    
    // Load booking requests
    async function loadBookingRequests() {
      try {
        const token = localStorage.getItem('token');
        console.log('Fetching pending bookings from:', `${config.apiBaseUrl}${config.apiEndpoints.bookings}/pending`);
        const response = await fetch(`${config.apiBaseUrl}${config.apiEndpoints.bookings}/pending`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          throw new Error('Failed to load booking requests');
        }

        const bookings = await response.json();
        const requestsContainer = document.getElementById('booking-requests');
        
        if (!requestsContainer) {
          console.error('Booking requests container not found');
          return;
        }
        
        const noBookingsMessage = document.getElementById('no-bookings-message');
        
        // Filter to only show pending bookings
        const pendingBookings = bookings.filter(booking => booking.status === 'pending');
        
        if (pendingBookings.length === 0) {
          if (noBookingsMessage) {
            noBookingsMessage.style.display = 'block';
          }
          requestsContainer.innerHTML = '';
          return;
        }
        
        if (noBookingsMessage) {
          noBookingsMessage.style.display = 'none';
        }
        
        // Create container for booking cards
        const bookingsGrid = document.createElement('div');
        bookingsGrid.className = 'booking-cards';
        requestsContainer.innerHTML = '';
        requestsContainer.appendChild(bookingsGrid);
        
        pendingBookings.forEach(booking => {
          const bookingEl = document.createElement('div');
          bookingEl.className = 'dashboard-card';
          
          const startTime = new Date(booking.startTime).toLocaleString();
          const endTime = new Date(booking.endTime).toLocaleString();
          
          // Extract booking ID safely
          const bookingId = booking._id || booking.id;
          console.log('Rendering booking:', bookingId);
          
          bookingEl.innerHTML = `
            <div class="booking-info">
              <h3>${booking.room?.name || 'Room'}</h3>
              <p><i class="fas fa-user"></i> ${booking.user?.name || 'User'}</p>
              <p><i class="fas fa-calendar"></i> ${startTime}</p>
              <p><i class="fas fa-clock"></i> ${endTime}</p>
              <p class="status-pending"><i class="fas fa-circle" style="font-size: 10px;"></i> Status: Pending</p>
              ${booking.reason ? `<p><i class="fas fa-comment"></i> Reason: ${booking.reason}</p>` : ''}
            </div>
            <div class="booking-actions" style="margin-top: 15px;">
              <button class="btn btn-primary approve-btn" data-booking-id="${bookingId}">
                <i class="fas fa-check"></i> Approve
              </button>
              <button class="btn btn-danger reject-btn" data-booking-id="${bookingId}">
                <i class="fas fa-times"></i> Reject
              </button>
            </div>
          `;
          
          bookingsGrid.appendChild(bookingEl);
        });
        
        // Add event listeners to the buttons
        addBookingActionListeners();
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to load booking requests. Please try again.');
      }
    }

    // Load rooms
    async function loadRooms() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${config.apiBaseUrl}${config.apiEndpoints.rooms}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          throw new Error('Failed to load rooms');
        }

        const rooms = await response.json();
        const roomList = document.getElementById('room-list');
        const noRoomsMessage = document.getElementById('no-rooms-message');

        if (rooms.length === 0) {
          noRoomsMessage.style.display = 'block';
          return;
        }

        noRoomsMessage.style.display = 'none';
        // Create a grid container
        const roomGrid = document.createElement('div');
        roomGrid.className = 'dashboard-cards';
        roomList.innerHTML = '';
        roomList.appendChild(roomGrid);
        
        rooms.forEach(room => {
          const roomEl = document.createElement('div');
          roomEl.className = 'dashboard-card';
          roomEl.innerHTML = `
            <h3>${room.name}</h3>
            <p><i class="fas fa-map-marker-alt"></i> ${room.location}</p>
            <p><i class="fas fa-users"></i> Capacity: ${room.capacity}</p>
            <div class="room-actions" style="margin-top: 15px;">
              <button onclick="editRoom('${room._id}')" class="btn btn-primary">
                <i class="fas fa-edit"></i> Edit
              </button>
              <button onclick="deleteRoom('${room._id}')" class="btn btn-danger">
                <i class="fas fa-trash"></i> Delete
              </button>
            </div>
          `;
          roomGrid.appendChild(roomEl);
        });
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to load rooms. Please try again.');
      }
    }

    // Room form modal functions
    function openRoomForm() {
      document.getElementById('modal-title').textContent = 'Create Room';
      document.getElementById('room-form').reset();
      document.getElementById('room-form-modal').style.display = 'block';
    }

    function closeRoomForm() {
      document.getElementById('room-form-modal').style.display = 'none';
    }

    // Approve booking
    async function approveBooking(bookingId) {
      try {
        if (!confirm('Are you sure you want to approve this booking?')) {
          return;
        }
        
        // Show loading indicator
        showNotification('Processing...', 'info');
        
        const token = localStorage.getItem('token');
        console.log('Approving booking with ID:', bookingId);
        console.log('Using endpoint:', `${config.apiBaseUrl}${config.apiEndpoints.bookings}/${bookingId}/approval`);
        
        const response = await fetch(`${config.apiBaseUrl}${config.apiEndpoints.bookings}/${bookingId}/approval`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status: 'confirmed' })
        });

        const responseData = await response.json();
        console.log('Approval response:', responseData);
        
        if (!response.ok) {
          throw new Error(responseData.message || 'Failed to approve booking');
        }

        // Show success notification
        showNotification('Booking approved successfully!', 'success');
        
        try {
          // Reload booking requests
          await loadBookingRequests();
          
          // Also update dashboard statistics
          await updateDashboardStats();
        } catch (innerError) {
          console.error('Error refreshing data after approval:', innerError);
        }
      } catch (error) {
        console.error('Error approving booking:', error);
        showNotification(`Failed to approve booking: ${error.message}`, 'error');
      }
    }

    // Reject booking
    async function rejectBooking(bookingId) {
      try {
        if (!confirm('Are you sure you want to reject this booking?')) {
          return;
        }
        
        // Show loading indicator
        showNotification('Processing...', 'info');
        
        const token = localStorage.getItem('token');
        console.log('Rejecting booking with ID:', bookingId);
        console.log('Using endpoint:', `${config.apiBaseUrl}${config.apiEndpoints.bookings}/${bookingId}/approval`);
        
        const response = await fetch(`${config.apiBaseUrl}${config.apiEndpoints.bookings}/${bookingId}/approval`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ 
            status: 'cancelled',
            rejectionReason: 'Rejected by admin'
          })
        });

        const responseData = await response.json();
        console.log('Rejection response:', responseData);
        
        if (!response.ok) {
          throw new Error(responseData.message || 'Failed to reject booking');
        }

        // Show success notification
        showNotification('Booking rejected successfully!', 'success');
        
        try {
          // Reload booking requests
          await loadBookingRequests();
          
          // Also update dashboard statistics
          await updateDashboardStats();
        } catch (innerError) {
          console.error('Error refreshing data after approval:', innerError);
        }
      } catch (error) {
        console.error('Error rejecting booking:', error);
        showNotification(`Failed to reject booking: ${error.message}`, 'error');
      }
    }

    // Create room
    document.getElementById('room-form').addEventListener('submit', async function(e) {
      e.preventDefault();

      try {
        const token = localStorage.getItem('token');
        const formData = new FormData(this);
        const roomData = Object.fromEntries(formData.entries());

        const response = await fetch(`${config.apiBaseUrl}/api/rooms`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(roomData)
        });

        if (!response.ok) {
          throw new Error('Failed to create room');
        }

        alert('Room created successfully');
        closeRoomForm();
        await loadRooms();
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to create room. Please try again.');
      }
    });

    // Edit room
    async function editRoom(roomId) {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${config.apiBaseUrl}${config.apiEndpoints.rooms}/${roomId}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          throw new Error('Failed to load room details');
        }

        const room = await response.json();
        document.getElementById('room-name').value = room.name;
        document.getElementById('room-location').value = room.location;
        document.getElementById('room-capacity').value = room.capacity;
        document.getElementById('modal-title').textContent = 'Edit Room';
        document.getElementById('room-form-modal').style.display = 'block';

        // Update form action to PUT
        document.getElementById('room-form').setAttribute('data-room-id', roomId);
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to load room details. Please try again.');
      }
    }

    // Handle room form submission for both create and edit
    document.getElementById('room-form').addEventListener('submit', async function(e) {
      e.preventDefault();

      const roomId = this.getAttribute('data-room-id');
      const token = localStorage.getItem('token');
      const formData = new FormData(this);
      const roomData = Object.fromEntries(formData.entries());

      try {
        if (roomId) {
          // Edit existing room
          const response = await fetch(`${config.apiBaseUrl}${config.apiEndpoints.rooms}/${roomId}`, {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(roomData)
          });

          if (!response.ok) {
            throw new Error('Failed to update room');
          }

          alert('Room updated successfully');
        } else {
          // Create new room
          const response = await fetch(`${config.apiBaseUrl}${config.apiEndpoints.rooms}`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(roomData)
          });

          if (!response.ok) {
            throw new Error('Failed to create room');
          }

          alert('Room created successfully');
        }

        closeRoomForm();
        await loadRooms();
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to save room. Please try again.');
      }
    });

    // Delete room
    async function deleteRoom(roomId) {
      try {
        if (!confirm('Are you sure you want to delete this room?')) {
          return;
        }

        const token = localStorage.getItem('token');
        const response = await fetch(`${config.apiBaseUrl}${config.apiEndpoints.rooms}/${roomId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          throw new Error('Failed to delete room');
        }

        alert('Room deleted successfully');
        await loadRooms();
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to delete room. Please try again.');
      }
    }

    // Logout
    document.getElementById('logout-link').addEventListener('click', (e) => {
      e.preventDefault();
      auth.logout();
    });
  </script>
</body>
</html>
